<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://www.thymeleaf.org" th:lang="${#locale.language}" lang="en">

<head>
    <meta charset="UTF-8" name="viewport"
          content="width=device-width, initial-scale=1.0"/>
    <title>Reset Password</title>
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="css/style.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script language="javascript">
    $(document).on('click', '.toggle-password', function () {
      $(this).toggleClass("fa-eye fa-eye-slash");
      var input = $("#password_one");
      input.attr('type') === 'password' ? input.attr('type', 'text') : input.attr('type', 'password')
    });
    $(document).on('click', '.toggle-password_Click', function () {
      $(this).toggleClass("fa-eye fa-eye-slash");
      var input = $("#password_two");
      input.attr('type') === 'password' ? input.attr('type', 'text') : input.attr('type', 'password')
    });

    function isEmpty(str) {
      return !str || 0 === str.trim().length;
    }
    function saveNewPassword() {
      var password_one = document.getElementById('password_one').value;
      var password_two = document.getElementById('password_two').value;
      if (password_one === '') {
        document.getElementById('password').innerHTML = 'New password is required';
        return false;
      } else {
        document.getElementById('password').innerHTML = '';
      }
      if (password_one.length <= 5 || password_one.length >= 20) {
        document.getElementById('password').innerHTML = 'Length must between 5 and 20';
        return false;
      } else {
        document.getElementById('password').innerHTML = '';
      }
      if (password_two === '') {
        document.getElementById('confirmpassword').innerHTML = 'Confirm password is required';
        return false;
      } else {
        document.getElementById('password').innerHTML = '';
      }
      if (password_one !== password_two) {
        document.getElementById('confirmpassword').innerHTML = 'New password and confirm password does not match';
        return false;
      } else {
        document.getElementById('confirmpassword').innerHTML = '';
      }

      var urlParams = new URLSearchParams(location.search);
      var tokenValue = urlParams.get('key');

      var objectData = {
        key: tokenValue,
        newPassword: password_one,
      };
      var object = JSON.stringify(objectData);

      var loc = window.location.pathname;
      var updateUrl=loc.replace('/account/reset/finish','');
      //https://stackoverflow.com/questions/26550124/spring-returning-empty-http-responses-with-responseentityvoid-doesnt-work
      //https://github.com/jquery/jquery/issues/3973
      //remove dataType: 'json' so it will accept void
      $.ajax({
        type: 'POST',
        url: updateUrl + '/api/account/reset-password/finish',
        contentType: 'application/json; charset=utf-8',
        data: object,
        success: function () {
          var x = document.getElementById("Successfully");
          x.className = "show";
          setTimeout(function () { x.className = x.className.replace("show", ""); }, 3000);
        },
       error: function () {
          var x = document.getElementById("snackbar");
          x.className = "show";
          setTimeout(function () { x.className = x.className.replace("show", ""); }, 3000);
        },
      });
    }

    </script>
</head>

<body>
<div class="row">
    <div class="col-md-4 d-flex flex-row-auto bgi-size-cover bgi-no-repeat p-10 p-lg-10 back-img"
         style="background-image: url(./images/bg-2.jpg);">
        <img src="images/logo.svg" class="max-h-100px image-container" alt="logo" width="300" height="600"/>
        </a>
    </div>

    <div class="col-md-4 col-md-offset-2 mt-5 ml-5">
        <form role="form" id="form">
            <div>
                <h2 class="text-center reset-title font-size-h1">
                    <strong>Reset Password</strong>
                </h2>
            </div>
            <div class="form-group mb-5">
                <label for="pwd">New Password <span class="required">*</span></label>
                <input type="password" class="form-control" id="password_one" placeholder="New Password" required/>
                <span toggle="#password-field"
                      class="fa fa-fw fa-eye field_icon toggle-password eye-icon float-right"></span>
                <span id="password" class="text-danger font-weight-bold"></span>
            </div>
            <div class="form-group mb-5">
                <label for="pwd">Confirm New Password <span class="required">*</span></label>
                <input type="password" class="form-control" id="password_two" placeholder="Confirm New Password"
                       required/>
                <span toggle="#password-field" class="fa fa-fw fa-eye field_icon toggle-password_Click eye-icon"></span>
                <span id="confirmpassword" class="text-danger font-weight-bold"></span>
            </div>
            <div class="pull-right">
                <input class="text-center button-save btn btn-primary" type="button" value="Reset"
                       onclick="saveNewPassword()"/>
            </div>
        </form>
        <div id="snackbar">Password has not been updated</div>
        <div id="Successfully">Password has been changed Successfully</div>
    </div>
</div>
</body>

</html>
